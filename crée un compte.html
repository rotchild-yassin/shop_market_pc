<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="crée un compte.css">
    <link rel="website icon" type="jpg" href="G1.jpg">
    
    
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="#" class="logo">Shop<span>Market</span></a>
        </div>
    </div>
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h2>Create Account</h2>
                        <div id="successMessage" class="success-message"></div>
                        <div id="serverError" class="server-error"></div>
                        <form id="signupForm" novalidate>
                            <div class="mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" placeholder="First name">
                                <div id="firstNameError" class="error-message"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" placeholder="Last name">
                                <div id="lastNameError" class="error-message"></div>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" placeholder="example@email.com">
                                <div id="emailError" class="error-message"></div>
                            </div>

                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" placeholder="29123456 or 95123456">
                                <div id="phoneError" class="error-message"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" placeholder="At least 6 characters">
                                <div id="passwordError" class="error-message"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Re-enter Password</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Re-enter password">
                                <div id="confirmPasswordError" class="error-message"></div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                                Create your ShopMarket account
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const form = document.getElementById('signupForm');
    const submitBtn = document.getElementById('submitBtn');
    const API_URL = 'http://localhost:3000/api/users';

    const isAlpha = (value) => /^[A-Za-z]+$/.test(value);
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    const isValidPhone = (phone) => /^[2954]\d{7}$/.test(phone.replace(/\D/g, ''));

    const clearErrors = () => {
        document.querySelectorAll('.error-message').forEach(el => {
            el.classList.remove('show');
            el.textContent = '';
        });
        document.querySelectorAll('.form-control').forEach(el => {
            el.classList.remove('is-invalid', 'is-valid');
        });
    };

    const showError = (id, msg) => {
        document.getElementById(id).textContent = msg;
        document.getElementById(id).classList.add('show');
        document.getElementById(id.replace('Error', '')).classList.add('is-invalid');
    };

    const markValid = (id) => {
        document.getElementById(id).classList.add('is-valid');
    };

    const validateForm = () => {
        clearErrors();
        let ok = true;

        const firstName = document.getElementById('firstName');
        const lastName = document.getElementById('lastName');
        const email = document.getElementById('email');
        const phone = document.getElementById('phone');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');

        if (!firstName.value || !isAlpha(firstName.value) || firstName.value.length > 7) {
            showError('firstNameError', 'The name is empty or invalid');
            ok = false;
        } else markValid('firstName');

        if (!lastName.value || !isAlpha(lastName.value) || lastName.value.length > 7) {
            showError('lastNameError', 'The last name is empty or invalid');
            ok = false;
        } else markValid('lastName');

        if (!email.value || !isValidEmail(email.value)) {
            showError('emailError', 'The email is not valid');
            ok = false;
        } else markValid('email');

        if (!phone.value || !isValidPhone(phone.value)) {
            showError('phoneError', 'The phone number is invalid');
            ok = false;
        } else markValid('phone');

        if (!password.value || password.value.includes(' ') || password.value.length > 10) {
            showError('passwordError', 'The password is not valid');
            ok = false;
        } else markValid('password');

        if (confirmPassword.value !== password.value) {
            showError('confirmPasswordError', 'The passwords do not match');
            ok = false;
        } else markValid('confirmPassword');

        return ok;
    };

    // ✅ FIXED: Save to server without blocking the redirect
    const saveUserToServer = (data) => {
        // Use setTimeout with 0ms to make it non-blocking
        setTimeout(() => {
            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => {
                if (res.ok) {
                    console.log('User saved to server successfully');
                }
            })
            .catch(err => {
                console.log('Server not available, data saved locally only');
            });
        }, 0);
    };

    form.addEventListener('submit', (e) => {
        e.preventDefault();

        if (!validateForm()) return;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        const userData = {
            id: Date.now(), // Add unique ID
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            password: document.getElementById('password').value
        };

        // ✅ Save to LocalStorage first
        localStorage.setItem('currentUser', JSON.stringify(userData));

        // ✅ Try to save to server (non-blocking)
        saveUserToServer(userData);

        // ✅ Always redirect immediately after saving to localStorage
        setTimeout(() => {
            window.location.href = 'electonic.html';
        }, 500); // Small delay to show "Saving..." message
    });
</script>
</body>